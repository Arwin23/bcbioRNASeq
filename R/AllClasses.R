#' bcbioRNASeq Object Class
#'
#' S4 class containing RNA-seq counts and metadata generated by
#' [bcbio](https://bcbio-nextgen.readthedocs.org/).
#'
#' `bcbioRNASeq` is a subclass of `SummarizedExperiment` designed to store
#' an RNA-seq analysis. This class contains raw read counts and transcripts per
#' million (TPM) generated by [tximport()].
#'
# Additional slots can be defined by setting the representation, if necessary.
# This is useful for including alternate count matrices (e.g. featureCounts).
#'
#' The `metadata` accessor contains:
#'
#' - Sample summary statistics (a.k.a. metrics).
#' - Ensembl annotations.
#' - Server run paths.
#' - R local environment information, including [sessionInfo()].
#'
#' @slot bcbio `SimpleList` containing additional bcbio run data with dimensions
#' that don't match the count matrix. This is currently used to store STAR
#' featureCounts aligned counts.
#'
#' @author Lorena Pantano, Michael Steinbaugh
#' @export
#'
#' @seealso
#' - [SummarizedExperiment::SummarizedExperiment].
#' - `.S4methods(class = "bcbioRNASeq")`.
#'
#' @examples
#' uploadDir <- system.file("extdata/bcbio", package = "bcbioRNASeq")
#'
#' bcb <- loadRNASeq(uploadDir)
#' print(bcb)
#'
#' # Check validity
#' validObject(bcb)
bcbioRNASeq <- setClass(
    "bcbioRNASeq",
    contains = "SummarizedExperiment",
    slots = c("bcbio" = "SimpleList")
)



# Validity =====================================================================
setValidity("bcbioRNASeq", function(object) {
    # SummarizedExperiment internal structure
    assert_is_all_of(object, "SummarizedExperiment")
    assert_has_dimnames(object)
    stopifnot(all(vapply(
        X = c(
            "assays",
            "bcbio",
            "colData",
            "elementMetadata",
            "metadata",
            "NAMES"
        ),
        FUN = function(slot) {
            .hasSlot(object, slot)
        },
        FUN.VALUE = logical(1L)
    )))

    # Required count matrices
    # Note that `rlog` and `vst` DESeqTransform objects are optional
    assert_is_subset(
        c("raw", "tpm", "length", "dds"),
        names(assays(object))
    )

    # Column data
    colDataFactor <- vapply(
        X = colData(object),
        FUN = is.factor,
        FUN.VALUE = logical(1L),
        USE.NAMES = TRUE
    )
    if (any(!colDataFactor)) {
        abort(paste(
            paste(
                "Non-factor colData columns:",
                toString(names(colDataFactor[!colDataFactor]))
            ),
            updateMsg,
            sep = "\n"
        ))
    }

    # Metadata
    requiredMetadata <- list(
        "version" = "package_version",
        "uploadDir" = "character",
        "sampleDirs" = "character",
        "projectDir" = "character",
        "template" = "character",
        "runDate" = "Date",
        "interestingGroups" = "character",
        "organism" = "character",
        "genomeBuild" = "character",
        "ensemblVersion" = c("integer", "NULL"),
        "annotationHub" = c("list", "NULL"),
        "tx2gene" = "data.frame",
        "lanes" = "integer",
        "yaml" = "list",
        "metrics" = "data.frame",
        "sampleMetadataFile" = c("character", "NULL"),
        "dataVersions" = "tbl_df",
        "programVersions" = "tbl_df",
        "bcbioLog" = "character",
        "bcbioCommandsLog" = "character",
        "allSamples" = "logical",
        "design" = "formula",
        "date" = "Date",
        "wd" = "character",
        "utilsSessionInfo" = "sessionInfo",
        "devtoolsSessionInfo" = "session_info",
        "unannotatedRows" = c("character", "NULL")
    )

    # Inform the user about renamed metadata slots
    legacyMetadata <- c(
        "gtf",
        "missingGenes",
        "programs"
    )
    intersect <- intersect(names(metadata(object)), legacyMetadata)
    if (length(intersect)) {
        abort(paste(
            paste(
                "Legacy metadata slots:",
                toString(sort(intersect))
            ),
            updateMsg,
            sep = "\n"
        ))
    }

    # Integrity check the classes of required metadata
    classChecks <- invisible(vapply(
        X = seq_along(requiredMetadata),
        FUN = function(a) {
            name <- names(requiredMetadata)[[a]]
            actual <- class(metadata(object)[[name]])
            expected <- requiredMetadata[[a]]
            if (!length(intersect(expected, actual))) {
                warn(paste(
                    name, "is not", toString(expected)
                ))
                FALSE
            } else {
                TRUE
            }
        },
        FUN.VALUE = logical(1L),
        USE.NAMES = FALSE
    ))
    if (!all(classChecks)) {
        abort(paste("Metadata class checks failed.", updateMsg, sep = "\n"))
    }

    # Metrics
    metrics <- metadata(object)[["metrics"]]
    assert_are_disjoint_sets(colnames(metrics), legacyMetricsCols)
    assert_has_rows(metrics)

    # rowData
    rowData <- rowData(object)
    if (!is.null(rowData)) {
        # Relax stringency for minimal example
        assert_is_subset(c("ensgene", "symbol"), colnames(rowData))
    }

    # Transcript to gene mappings
    tx2gene <- metadata(object)[["tx2gene"]]
    assertIsTx2gene(tx2gene)

    TRUE
})
