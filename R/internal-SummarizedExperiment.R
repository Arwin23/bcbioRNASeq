#' RNA-Seq SummarizedExperiment
#'
#' Contains counts generated by [tximport()], along with bcbio-nextgen
#' run metadata.
#'
#' @rdname SummarizedExperiment
#' @keywords internal
#'
#' @author Michael Steinbaugh
#'
#' @param txi tximport list.
#' @param colData Sample metadata.
#' @param rowData Ensembl gene annotations.
#' @param metadata Custom metadata.
#'
#' @return [SummarizedExperiment].
.SummarizedExperiment <- function(txi, colData, rowData, metadata = NULL) {
    message("Packaging SummarizedExperiment")

    # tximport ----
    counts <- txi[["counts"]]
    abundance <- txi[["abundance"]]  # tpm
    length <- txi[["length"]]
    counts_from_abundance <- txi[["countsFromAbundance"]]

    # TMM normalization ----
    tmm <- .tmm(counts)

    # Metadata ----
    if (is.null(metadata)) {
        metadata <- SimpleList()
    } else if (class(metadata) != "SimpleList") {
        metadata <- as(metadata, "SimpleList")
    }
    metadata[["counts_from_abundance"]] <- counts_from_abundance

    # Prepare colData and rowData ----
    colData <- colData[colnames(counts), ]
    rownames(colData) <- colnames(counts)

    rowData <- rowData[rownames(counts), ]
    rownames(rowData) <- rownames(counts)
    # [TODO] How to handle deprecated Ensembl identifiers?
    # Examples: ENSMUSG00000029333, ENSMUSG00000035349, ENSMUSG00000042402

    if (!identical(rownames(rowData), rownames(counts))) {
        stop("Gene identifier mismatch")
    }

    # SummarizedExperiment ----
    SummarizedExperiment(
        assays = SimpleList(
            counts = counts,
            abundance = abundance,
            length = length,
            tmm = tmm),
        colData = colData,
        rowData = rowData,
        metadata = metadata)
}
