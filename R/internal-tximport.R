#' Import RNA-Seq Counts
#'
#' Import RNA-seq counts using [tximport()]. Currently supports
#' [salmon](https://combine-lab.github.io/salmon/) (**recommended**) and
#' [sailfish](http://www.cs.cmu.edu/~ckingsf/software/sailfish/).
#'
#' @author Michael Steinbaugh, Rory Kirchner
#' @keywords internal
#' @noRd
#'
#' @importFrom fs dir_ls path
#' @importFrom readr read_tsv
#' @importFrom tximport tximport
#'
#' @inheritParams tximport::tximport
#'
#' @param sampleDirs Sample directories to import.
#' @param type *Optional.* Manually specify the expression caller to use.
#'   If `NULL`, if defaults to our preferred priority.
#'
#' @seealso
#' - [tximport::tximport()].
#'
#' @return `list` containing count matrices.
.tximport <- function(
    sampleDirs,
    type = NULL,
    txIn = TRUE,
    txOut = FALSE,
    tx2gene
) {
    assert_all_are_dirs(sampleDirs)
    assertIsAStringOrNULL(type)
    if (is_a_string(type)) {
        assert_is_subset(type, validCallers)
    }
    assertIsTx2gene(tx2gene)
    tx2gene <- as.data.frame(tx2gene)

    # Check for count output format, by using the first sample directory
    subdirs <- dir_ls(
        path = sampleDirs[[1]],
        type = "directory",
        recursive = FALSE
    )
    assert_are_intersecting_sets(basename(subdirs), validCallers)

    # Set the default priority if caller isn't specified
    if (!is_a_string(type)) {
        if ("salmon" %in% basename(subdirs)) {
            type <- "salmon"
        } else if ("kallisto" %in% basename(subdirs)) {
            type <- "kallisto"
        } else if ("sailfish" %in% basename(subdirs)) {
            type <- "sailfish"
        }
    }

    # Locate `quant.sf` files for salmon or sailfish output
    if (type %in% c("salmon", "sailfish")) {
        files <- dir_ls(
            path = path(sampleDirs, type),
            recursive = TRUE,
            type = "file",
            glob = "quant.sf"
        )
    } else if (type == "kallisto") {
        files <- dir_ls(
            path = path(sampleDirs, type),
            recursive = TRUE,
            type = "file",
            glob = "abundance.h5"
        )
    }
    assert_all_are_existing_files(files)
    names(files) <- names(sampleDirs)

    # Begin loading of selected counts
    inform(paste("Reading", type, "counts using tximport"))

    # Import the counts as length-scaled transcripts per million
    # https://goo.gl/h6fm15
    countsFromAbundance <- "lengthScaledTPM"

    tximport(
        files = files,
        type = type,
        txIn = txIn,
        txOut = txOut,
        countsFromAbundance = countsFromAbundance,
        tx2gene = tx2gene,
        ignoreTxVersion = TRUE,
        importer = read_tsv
    )
}
