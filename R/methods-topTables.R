#' Top Tables of Differential Expression Results
#'
#' @rdname topTables
#' @name topTables
#' @author Michael Steinbaugh
#'
#' @inheritParams general
#'
#' @param object DESeq2 results tables list generated by [resultsTables()].
#' @param n Number genes to report.
#' @param coding Whether to only return coding genes.
#'
#' @return Top table kables, for knit report.
#'
#' @examples
#' load(system.file(
#'     file.path("extdata", "bcb.rda"),
#'     package = "bcbioRNASeq"))
#' load(system.file(
#'     file.path("extdata", "res.rda"),
#'     package = "bcbioRNASeq"))
#'
#' annotable <- annotable(bcb)
#' resTbl <- resultsTables(
#'     res,
#'     annotable = annotable,
#'     summary = FALSE,
#'     write = FALSE)
#' topTables(resTbl)
NULL



# Constructors =================================================================
#' @importFrom basejump fixNA
#' @importFrom dplyr filter mutate rename
#' @importFrom S4Vectors head
#' @importFrom tibble remove_rownames
.subsetTop <- function(
    object,
    n = 50L,
    coding = FALSE) {
    assert_is_data.frame(object)
    assert_has_colnames(object)
    assert_has_rows(object)
    assert_is_implicit_integer(n)
    assert_is_a_bool(coding)

    keepCols <- c(
        "ensgene",
        "baseMean",
        "lfc",
        "padj",
        "symbol",
        "description",
        "broadClass"
    )
    assert_is_subset(keepCols, colnames(object))

    if (isTRUE(coding)) {
        assert_is_subset("broadClass", colnames(object))
        object <- object %>%
            .[.[["broadClass"]] == "coding", , drop = FALSE]
    }

    if (!nrow(object)) {
        return(NULL)
    }

    object %>%
        head(n = n) %>%
        rename(lfc = .data[["log2FoldChange"]]) %>%
        mutate(
            baseMean = round(.data[["baseMean"]]),
            lfc = format(.data[["lfc"]], digits = 3L),
            padj = format(.data[["padj"]], digits = 3L, scientific = TRUE),
            # Remove symbol information in description, if present
            description = gsub(
                x = .data[["description"]],
                pattern = " \\[.+\\]$",
                replacement = "")
        ) %>%
        .[, which(colnames(.) %in% keepCols)] %>%
        remove_rownames() %>%
        fixNA()
}



#' @importFrom knitr kable
.topTables.list <- function(  # nolint
    object,
    n = 50L,
    coding = FALSE) {
    # Passthrough: n, coding
    up <- .subsetTop(
        object[["degLFCUp"]],
        n = n,
        coding = coding)
    down <- .subsetTop(
        object[["degLFCDown"]],
        n = n,
        coding = coding)
    contrastName <- object[["contrast"]]
    if (!is.null(up)) {
        show(kable(
            up,
            caption = paste(contrastName, "(upregulated)")
        ))
    }
    if (!is.null(down)) {
        show(kable(
            down,
            caption = paste(contrastName, "(downregulated)")
        ))
    }
}



# Methods ======================================================================
#' @rdname topTables
#' @export
setMethod(
    "topTables",
    signature("list"),
    .topTables.list)
