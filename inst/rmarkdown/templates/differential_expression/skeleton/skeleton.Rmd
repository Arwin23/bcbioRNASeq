---
title: "Differential Expression"
author: "`r getOption('author')`"
date: "`r Sys.Date()`"
bibliography: bcbioRnaseq.bib
params:
    bcb: "data/bcb.rda"
    design: !r formula(~genotype)
    contrast: !r genotype = c("genotype", "mutant", "wildtype")
    alpha: 0.05
    lfc: 0
    outputDir: "."
---

```{r setup, cache=FALSE, message=FALSE}
source("setup.R")
library(DESeq2)

# bcbioRNADataSet
# Need to save bcb using `loadRNASeqRun()` prior to knit!
bcbName <- load(params$bcb)
assign("bcb", get(bcbName))
if (!is(bcb, "bcbioRNADataSet")) {
    stop("bcb must bcbioRNADataSet class object")
}

# Design formula
# help("design", "DESeq2")
design <- params$design

# Contrast
# help("results", "DESeq2")
#   1. Design matrix parameter.
#   2. Numerator for LFC (expt).
#   3. Denominator for LFC (control).
contrast <- params$contrast

# Significance cutoffs
alpha <- params$alpha
lfc <- params$lfc

# Directory paths
outputDir <- normalizePath(params$outputDir)
dataDir <- file.path(outputDir, "data")
countsDir <- file.path(outputDir, "results", "counts")
deDir <- file.path(outputDir, "results", "differential_expression")
```

```{r header, child="_header.Rmd"}
```



```{r dds, results="hide"}
dds <- DESeqDataSetFromTximport(
    txi = txi(bcb),
    colData = colData(bcb),
    design = design) %>%
    DESeq
saveData(dds, dir = dataDir)
```



# Alpha level (FDR) cutoffs

Let's take a look at the number of genes we get with different false discovery rate (FDR) cutoffs. These tests subset *P* values that have been multiple test corrected using the Benjamini Hochberg (BH) method [@Benjamini:1995ws].

```{r alphaSummary, results="asis"}
alphaSummary(dds)
```



# Results

```{r res}
resUnshrunken <- results(
    dds,
    contrast = contrast,
    alpha = alpha)

# DESeqResults with shrunken log2 fold changes (LFC)
# help("lfcShrink", "DESeq2")
# Use the correct coef number to modify from resultsNames(dds)
resShrunken <- lfcShrink(
    dds = dds,
    contrast = contrast,
    coef = 2,
    res = resUnshrunken)

# Use shrunken LFC values by default
res <- resShrunken
saveData(res, resUnshrunken, resShrunken, dir = dataDir)
```

We performed the analysis using a BH adjusted *P* value cutoff of `r alpha` and a log fold-change (LFC) ratio cutoff of `r lfc`.



# Plots

## Mean average (MA)

An MA plot compares transformed counts on `M` (log ratio) and `A` (mean average) scales [@Yang:2002ty].

```{r plotMA}
plotMA(res)
```


## Volcano

A volcano plot compares significance (BH-adjusted *P* value) against fold change (log2) [@Cui:2003kh; @Li:2014fv]. Genes in the green box with text labels have an adjusted *P* value are likely to be the top candidate genes of interest.

```{r plotVolcano}
plotVolcano(bcb, res = res, lfc = lfc)
```


## Heatmap

This plot shows only differentially expressed genes on a per-sample basis. We have scaled the data by row and used the `ward.D2` method for clustering [@WardJr:1963eu].

```{r plotDEGHeatmap}
plotDEGHeatmap(bcb, res = res, lfc = lfc)
```



# File downloads

The results are saved as gzip-compressed comma separated values (CSV). Gzip compression is natively supported on [macOS][] and Linux-based operating systems. If you're running Windows, we recommend installing [7-Zip][]. CSV files can be opened in [Excel][] or [RStudio][].


## Count matrices

- [`normalized_counts.csv.gz`](`r file.path(countsDir, "normalized_counts.csv.gz")`): Use to evaluate individual genes and/or generate plots. These counts are normalized for the variation in sequencing depth across samples.
- [`tpm.csv.gz`](`r file.path(countsDir, "tpm.csv.gz")`): Transcripts per million, scaled by length and also suitable for plotting.
- [`raw_counts.csv.gz`](`r file.path(countsDir, "raw_counts.csv.gz")`): Only use to perform a new differential expression analysis. These counts will vary across samples due to differences in sequencing depth, and have not been normalized. Do not use this file for plotting genes.


## Differentially expressed genes (DEG)

DEG tables are sorted by BH-adjusted P value, and contain the following columns:

- `ensgene`: [Ensembl][] gene identifier.
- `baseMean`: Mean of the normalized counts per gene for all samples.
- `log2FoldChange`: log2 fold change.
- `lfcSE`: log2 standard error.
- `stat`: Wald statistic.
- `pvalue`: Walt test *P* value.
- `padj`: BH adjusted Wald test *P* value (corrected for multiple comparisons; aka FDR).
- `externalGeneName`: [Ensembl][] name (a.k.a. symbol).
- `description`: [Ensembl][] description.
- `geneBiotype`: [Ensembl][] biotype (e.g. `protein_coding`).

```{r resultsTables, results="asis"}
resTbl <- resultsTables(bcb, res = res, lfc = lfc, dir = deDir)
saveData(resTbl, dir = dataDir)
```



# Top tables

Only the top up- and down-regulated genes (arranged by log2 fold change) are shown.

```{r topTables, results="asis"}
topTables(resTbl)
```



```{r footer, child="_footer.Rmd"}
```
