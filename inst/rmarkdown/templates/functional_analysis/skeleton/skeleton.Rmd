---
title: "Functional Analysis"
author: "`r getOption('author')`"
date: "`r Sys.Date()`"
bibliography: bibliography.bib
params:
    bcb_file: "bcb.rda"
    res_file: "res.rda"
    organism: "Mm"
    gspecies: "mmu"
    species: "mouse"
    lfc: 0
    go_class: "BP"
    data_dir: "."
    results_dir: "results/functional_analysis"
---

```{r setup, message=FALSE}
# Last modified 2018-03-17
# 
# Mouse (default)
# - organism: "Mm"
# - gspecies: "mmu"
# - species: "mouse"
# 
# Human
# - organism: "Hs"
# - gspecies: "hsa"
# - species: "human"

# Load the required enrichment-specific packages first
org_db <- paste("org", params$organism, "eg", "db", sep = ".")
packages <- c(
    org_db,
    "clusterProfiler",
    "DOSE",
    "pathview"
)
if (!all(basename(packages) %in% rownames(installed.packages()))) {
    notInstalled <- setdiff(basename(packages), rownames(installed.packages()))
    source("https://bioconductor.org/biocLite.R")
    biocLite(pkgs = notInstalled)
}
invisible(lapply(
    X = basename(packages),
    FUN = library,
    character.only = TRUE
))

# Now load the shared R Markdown setup script
bcbioRNASeq::prepareRNASeqTemplate()
source("_setup.R")

# Directory paths
kegg_plots_dir <- file.path(params$results_dir, "kegg_plots")
invisible(mapply(
    FUN = dir.create,
    path = c(data_dir, results_dir, kegg_plots_dir),
    MoreArgs = list(showWarnings = FALSE, recursive = TRUE)
))

# Load bcbioRNASeq and DESeqResults objects
bcb_name <- load(params$bcb_file)
bcb <- get(bcb_name, inherits = FALSE)
stopifnot(is(bcb, "bcbioRNASeq"))
invisible(validObject(bcb))

res_name <- load(params$res_file)
res <- get(res_name, inherits = FALSE)
stopifnot(is(res, "DESeqResults"))
invisible(validObject(res))
res <- res[!is.na(res$padj), , drop = FALSE]
alpha <- metadata(res)$alpha
```

```{r header, child="_header.Rmd"}
```



```{r identifiers, message=FALSE, warning=FALSE}
# FIXME Remove the bitr code here
all_genes <- rownames(res) %>%
    as.character()
sig_genes <- significants(
    res,
    fc = params$lfc,
    padj = alpha
)
# Convert Ensembl gene identifiers to Entrez
ensembl2entrez <- bitr(
    all_genes,
    fromType = "ENSEMBL",
    toType = "ENTREZID",
    OrgDb = org_db
) %>%
    camel()
all_entrez <- unique(ensembl2entrez$entrezid)
sig_entrez <- bitr(
    sig_genes,
    fromType = "ENSEMBL",
    toType = "ENTREZID",
    OrgDb = org_db) %>%
    camel() %>%
    .$entrezid %>%
    unique()
```

```{r sig_tables}
sig_results <- res %>%
    as.data.frame() %>%
    .[sig_genes, , drop = FALSE]

fold_changes <- sig_results$log2FoldChange
names(fold_changes) <- rownames(sig_results)

fdr_ordered <- res %>%
    as.data.frame() %>%
    .[order(.$padj), , drop = FALSE]
```



# GO enrichment analysis

Gene Ontology (GO) term enrichment is a technique for interpreting sets of genes making use of the Gene Ontology system of classification, in which genes are assigned to a set of predefined bins depending on their functional characteristics.

```{r enrich_go}
# Run GO enrichment analysis
enrich_go <- enrichGO(
    sig_genes,
    "ENSEMBL",
    universe = all_genes,
    OrgDb = org_db,
    ont = params$go_class,
    pAdjustMethod = "BH",
    qvalueCutoff = 0.05,
    readable = TRUE)
saveData(enrich_go, dir = params$data_dir)

# Show summary data.frame
enrich_go_summary <- slot(enrich_go, "result") %>%
    as_tibble() %>%
    camel()
write_csv(
    enrich_go_summary,
    path = file.path(params$results_dir, paste0(paste(
        "go",
        tolower(params$go_class),
        "clusterprofiler",
        "padj",
        alpha,
        "lfc",
        params$lfc,
        sep = "_"),
        ".csv.gz")))
enrich_go_summary
```



# DOTplot

```{r dotplot, fig.width=8}
# Dotplot of top 25
dotplot(enrich_go, showCategory = 25)
```



# GO terms map

```{r enrich_map, fig.width=8, fig.height=8}
# Enrichment plot of top 25
enrichMap(enrich_go, n = 25, vertex.label.cex = 0.5)
```



# Gene map

In order to consider the potentially biological complexities in which a gene may belong to multiple annotation categories and provide information of numeric changes if available

```{r cnetplot, fig.width=8, fig.height=8}
# Cnet plot with genes colored by fold changes for top 5 most significant GO
# processes
cnetplot(
    enrich_go,
    categorySize = "pvalue",
    showCategory = 5,
    foldChange = fold_changes,
    vertex.label.cex = 0.5)
```



# KEGG analysis

```{r enrich_kegg}
kegg <- enrichKEGG(
    gene = sig_entrez,
    universe = all_entrez,
    organism = params$species)
saveData(kegg, dir = params$data_dir)

# Show KEGG summary data.frame
kegg_summary <- slot(kegg, "result") %>%
    as_tibble() %>%
    camel()
write_csv(
    kegg_summary,
    path = file.path(params$results_dir, paste0(paste(
        "kegg",
        "clusterprofiler",
        "padj",
        alpha,
        "lfc",
        params$lfc,
        sep = "_"),
        ".csv.gz")))
kegg_summary
```



# GO GSEA analysis

A common approach in analyzing gene expression profiles was identifying differential expressed genes that are deemed interesting. The enrichment analysis we demonstrated previously were based on these differentially expressed genes. This approach will find genes where the difference is large, but it will not detect a situation where the difference is small, but evidenced in coordinated way in a set of related genes. Gene Set Enrichment Analysis (GSEA) directly addresses this limitation. All genes can be used in GSEA; GSEA aggregates the per gene statistics across genes within a gene set, therefore making it possible to detect situations where all genes in a predefined set change in a small but coordinated way. Since it is likely that many relevant phenotypic differences are manifested by small but consistent changes in a set of genes.

```{r gsea_go}
# Prepare the gene list
gene_list <- 1 - fdr_ordered$padj
names(gene_list) <- row.names(fdr_ordered)
gene_list <- gene_list[!is.na(gene_list)]

# Now run GSEA
gsea_go <- gseGO(
    geneList = gene_list,
    OrgDb = org_db,
    ont = params$go_class,
    keyType = "ENSEMBL",
    nPerm = 1000,
    minGSSize = 100,
    maxGSSize = 500,
    pvalueCutoff = 0.05,
    verbose = FALSE)
saveData(gsea_go, dir = params$data_dir)

# Write out summary data.frame
gsea_go_summary <- slot(gsea_go, "result") %>%
    as_tibble() %>%
    camel()
write_csv(
    gsea_go_summary,
    path = file.path(params$results_dir, paste0(paste(
        "gsea",
        "clusterprofiler",
        "padj",
        alpha,
        "lfc",
        params$lfc,
        sep = "_"),
        ".csv.gz")))
gsea_go_summary
```



# KEGG GSEA analysis

We can also perform GSEA analysis with clusterProfiler using KEGG gene sets and using the log2 fold changes as input. By using the log2 fold changes as the input, we are identifying pathways with genes that exhibit coordinated fold changes that are larger than might be expected by chance. The significant pathways can be visualized using the log2 fold changes with the Pathview tool.

```{r kegg_gsea}
res_tbl_entrez <- res %>%
    as.data.frame() %>%
    rownames_to_column("ensembl") %>%
    as_tibble() %>%
    # Use the full join option here to include all Entrez identifiers
    full_join(ensembl2entrez, by = "ensembl") %>%
    dplyr::select(entrezid, ensembl, everything()) %>%
    # Remove rows with duplicate Entrez identifiers
    filter(!duplicated(entrezid))

# Extract the fold changes
fold_changes <- res_tbl_entrez$log2FoldChange
names(fold_changes) <- res_tbl_entrez$entrezid
fold_changes <- sort(fold_changes, decreasing = TRUE)

# GSEA using gene sets from KEGG pathways
gsea_kegg <- gseKEGG(
    geneList = fold_changes,
    organism = tolower(params$gspecies),
    nPerm = 1000,
    minGSSize = 120,
    pvalueCutoff = 0.05,
    verbose = FALSE)
saveData(gsea_kegg, dir = params$data_dir)

# Extract the GSEA results
gsea_kegg_summary <- slot(gsea_kegg, "result") %>% as_tibble()
write_csv(
    gsea_kegg_summary,
    path = file.path(params$results_dir, "gsea_kegg_clusterprofiler.csv.gz"))
gsea_kegg_summary
```

```{r kegg_plots, message=FALSE, results='asis'}
# dplyr must be unloaded at this step for pathview to work
suppressWarnings(detach("package:dplyr", unload = TRUE, force = TRUE))

# If there is an error at this step, there may be a pathway that is not found by
# pathview package. In this case, you may need to run the pathview command above
# by specifying the index of the pathways you would like to print out in place
# of `x`.
pathways <- gsea_kegg_summary$ID

# There is currently no way to set the output path of the pathview PNG files.
# We're using tryCatch here to return to the user pathways that didn't output
# graphics correctly.
wd <- getwd()
setwd(kegg_plots_dir)
invisible(lapply(pathways, function(pathway) {
    tryCatch(
        pathview(
            gene.data = fold_changes,
            pathway.id = pathway,
            species = tolower(params$gspecies), 
            limit = list(gene = 2, cpd = 1)),
        error = function(e) {
            # Return a warning instead of an error
            warning(paste(pathway, "failed to plot"), call. = FALSE)
        }
    )
}))
setwd(wd)

figures <- list.files(kegg_plots_dir, pattern = "pathview", full.names = TRUE)
invisible(lapply(figures, function(figure) {
    cat(paste0("<img src=\"", figure, "\">\n"))
}))
```



```{r footer, child="_footer.Rmd"}
```
